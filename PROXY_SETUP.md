# Настройка прокси для Claude API

Поскольку Claude API может быть недоступен в некоторых регионах, приложение поддерживает работу через SOCKS5/HTTP прокси.

## Варианты настройки

### Вариант 1: Указание явного IP адреса хоста (Рекомендуется)

Если ваш прокси запущен на том же сервере, но слушает только на localhost:

1. Найдите IP адрес вашего сервера:
```bash
hostname -I | awk '{print $1}'
```

2. Настройте прокси чтобы слушать на этом IP или на всех интерфейсах (0.0.0.0):
```bash
# Пример для ssh SOCKS proxy
ssh -D 0.0.0.0:1080 -N user@remote-server

# Или для dante-server, отредактируйте /etc/danted.conf:
internal: 0.0.0.0 port = 1080
```

3. Добавьте в .env файл:
```env
ANTHROPIC_PROXY_URL=socks5://127.0.0.1:1080
PROXY_HOST_IP=YOUR_SERVER_IP  # Замените на реальный IP сервера
```

### Вариант 2: Использование host network mode

Используйте специальный docker-compose файл с host network mode:

```bash
docker-compose -f docker-compose.host.yml up -d
```

В этом режиме контейнер будет использовать сеть хоста напрямую и сможет обращаться к localhost:1080.

**Важно:** При использовании host network mode убедитесь, что порты 8000, 5432, 6379 не заняты другими сервисами.

### Вариант 3: Автоматическое определение (может не работать)

Приложение пытается автоматически определить IP адрес Docker gateway и использовать его для доступа к прокси. Это работает не во всех конфигурациях.

## Проверка работы прокси

1. Проверьте, что прокси работает:
```bash
curl --socks5 127.0.0.1:1080 https://api.anthropic.com/v1/messages
```

2. Проверьте логи приложения:
```bash
docker logs family_emotions_app | grep -i proxy
```

Вы должны увидеть сообщения вроде:
- `Found Docker gateway IP via ip route: X.X.X.X`
- `Using explicit proxy host IP: X.X.X.X`
- `Proxy configured successfully with: socks5://X.X.X.X:1080`

## Устранение проблем

### "Connection error" или "All connection attempts failed"

Это означает, что контейнер не может подключиться к прокси. Проверьте:

1. Прокси запущен и работает
2. Прокси слушает на правильном интерфейсе (не только на localhost)
3. Firewall не блокирует подключения
4. Правильно указан PROXY_HOST_IP в .env файле

### "Name or service not known"

Это означает, что не удается разрешить имя хоста. Используйте явный IP адрес вместо host.docker.internal.

## Рекомендуемая конфигурация для продакшена

1. Запустите прокси на всех интерфейсах или на конкретном IP
2. Используйте явный PROXY_HOST_IP в .env
3. Добавьте firewall правила для защиты прокси от внешнего доступа